---
title: "key_driver_function"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```
Step: Library packages and load data
```{r}
library(pacman)
renv::restore()
pacman::p_load(renv, dplyr, shiny, shinydashboard, shinydashboardPlus, tidyverse, glue, plotly, devtools, shinyWidgets, fontawesome, formattable, janitor, tsibble, DT, readr, lubridate, tidymodels, ggrepel, vip)

setwd("~/shiny_360_app_example/src")
source(knitr::purl(glue("~/shiny_360_app_example/src/data_generation_a360.Rmd")))

nps_data
```
Step: Setup the function
```{r}
key_driver_function = function(data, outcome){
  
nps <- quo(outcome)

data_out = data %>%
    rename(nps = UQ(nps))
  
 driver_recipe <- recipe(nps ~ ., data = data_out) %>% 
      ## Can help make the distribution more symmetric                     
      step_YeoJohnson(all_numeric(), -all_outcomes()) %>% 
      ### Create z-scores for data to reduce collinearity
      step_normalize(all_numeric(), -all_outcomes()) %>%
      ## Impute missing values
      step_impute_knn(all_predictors()) %>%
      ## Remove variables with .9 correlation or higher
      step_corr(all_predictors(), method = "spearman") %>%
      ## Remove all variables with no or near zero variance
      step_nzv(all_predictors())
 
driver_model <- linear_reg() %>% 
      set_engine('lm') %>% 
      set_mode('regression')
    
driver_data_baked <- driver_recipe %>% 
      prep() %>% 
      bake(new_data = data)

driver_final_fit <- driver_model %>% 
      fit(nps ~ ., data = driver_data_baked)

driver_fit_import = vi_model(driver_final_fit)

driver_fit_import = driver_fit_import %>%
      clean_names() %>% 
      mutate(importance = round(importance, 2))

 likert_out =  data_out %>%
      select(-c(nps)) %>%
      t() %>%
      data.frame() %>%
      mutate(one = rowSums(. == "1")) %>% 
      mutate(two = rowSums(. == "2")) %>% 
      mutate(three = rowSums(. == "3")) %>%
      mutate(four = rowSums(. == "4")) %>%
      mutate(five = rowSums(. == "5")) %>%
      select(one:five) %>%
      mutate_all(funs(./dim(data_out)[1])) %>%
      mutate_all(funs(formattable::percent(., digits = 0))) %>%
      mutate(positive = four+five) %>%
      select(positive) %>%
      add_rownames("variable")

key_drivers_data = driver_fit_import %>%
      select(-c(sign)) %>%
      left_join(likert_out %>% select(variable, positive), by  = "variable")
     
key_drivers_data <- key_drivers_data %>%
      mutate(color = if_else(positive < mean(positive) & importance > mean(importance), "red", if_else(positive > mean(positive) & importance > mean(importance), "blue", "grey"))) 
    ### Rename the variables 

return(key_drivers_data)

}


```
Step: Test out the function
```{r}
nps_data_driver = nps_data %>%
  select(-c(year_quarter, account_names))

key_driver_function(data = nps_data_driver, outcome = "nps")
```
Step: Graph function for key drivers
```{r}

key_drivers_graph_function = function(data){
  


max_min_change = .3
y_adjustment = .1

x_max = max(key_drivers_data$importance) +  max(key_drivers_data$importance)*max_min_change
x_min = min(key_drivers_data$importance) - min(key_drivers_data$importance)*max_min_change
y_max = max(key_drivers_data$positive) +  max(key_drivers_data$positive)*max_min_change
y_min = min(key_drivers_data$positive) - min(key_drivers_data$positive)*max_min_change


title = paste0("Key drivers")

kd <- ggplot(key_drivers_data,aes(importance, positive, label = variable))+
  geom_point()+
  ylim(y_min, y_max) +
  xlim(x_min, x_max) +
  theme_bw() + theme(panel.border = element_blank(), panel.grid.major = element_blank(),
                     panel.grid.minor = element_blank(), axis.line = element_line(colour = "black")) +
  labs(x = "Importance", y =  "Favorable") +
  geom_hline(yintercept=median(key_drivers_data$positive))+
  geom_vline(xintercept=median(key_drivers_data$importance)) +
  labs(x = "Importance", y =  "Favorable") +
  ggtitle(title) +
  geom_text_repel(data = key_drivers_data %>% filter(color == "red"), aes(label = variable),
                  size = 3.5,  color = "#FF0000") +
  geom_text_repel(data = key_drivers_data %>% filter(color == "blue"), aes(label = variable),
                  size = 3.5,  color = "#00B0F0") +
  geom_text_repel(data = key_drivers_data %>% filter(color == "grey"), aes(label = variable),
                  size = 3.5,  color = "#808080") +
  coord_flip()
return(kd)
}

```
Step: Use both functions
```{r}
key_drivers_data = key_driver_function(data = nps_data_driver, outcome = "nps")

key_drivers_graph_function(key_drivers_data)

```




  
    

    
 
    

    
